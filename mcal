#!/usr/bin/env bash

# mcal: Display and modify calendar events stored in local text files.

# Edit calendar files
[[ $1 == "e" ]] && (cd "$MCAL_DATA_DIR" && nvim -c FZF) && exit

# File locations
declare birthday_events="$MCAL_DATA_DIR/Birthdays"
declare template_birthdays="$MCAL_DATA_DIR/templates/template_birthdays"

# Global variables
declare -r day=86400 # Number of seconds in a day
declare today
declare events
declare -a start_dates
declare start_time
declare end_date
declare end_time
declare duration
declare calendar
declare tags_formatted
declare title
declare location
declare notes

compile_events()
{
	today=$(printf "%(%F %a %H:%M)T       === TODAY ===" -1)
	events=$(find "$MCAL_DATA_DIR" -maxdepth 1 -type f -exec cat {} + && printf "%s\n" "$today")
}

repeating_event()
{
	local getdates_command="getdates"
	local mode
	local interval
	local unit
	local mn
	local weekday
	local end_repeat

	read -rp "Mode (r or m): " mode

	case $mode in
		"r")
			# Reference date mode
			getdates_command+=" r"

			read -rp "Repeat every: " interval
			getdates_command+=" -i $interval"

			select unit in "Days" "Weeks" "Weekday"; do
				case $unit in
					"Days")
						getdates_command+=" -d"
						;;
					"Weeks")
						getdates_command+=" -w"
						;;
				esac
				break
			done
			;;

		"m")
			# Monthly mode
			getdates_command+=" m"

			read -rp "Repeat every (number): " mn

			select unit in "Day of month" "Weekday"; do
				case $unit in
					"Day of month")
						getdates_command+=" -d -mn $mn"
						;;
					"Weekday")
						select weekday in "Monday" "Tuesday" "Wednesday" \
							"Thursday" "Friday" "Saturday" "Sunday"; do
							getdates_command+=" -k ${weekday:0:3} -mn $mn"
							break
						done
						;;
				esac
				break
			done
			;;

	esac

	read -rp "Until (date): " end_repeat
	getdates_command+=" -e $end_repeat"

	mapfile -t start_dates < <($getdates_command)
}

enter_new_event()
{
	local -l tags_input
	local -a tags
	local -a calendars

	# Title
	read -rp "Title: " title

	# Start date
	read -rp "Start date: " start_date
	start_dates=("$(date --date="${start_date:="today 12 am"}" +%s)")

	# Start time
	read -rp "Start time: " start_time
	[[ $start_time ]] && start_time=$(date --date="$start_time" +%R)

	# End date
	read -rp "End date: " end_date
	end_date=$(date --date="${end_date:=@"${start_dates[0]}"}" +%s)

	# Event duration
	duration=$((end_date - "${start_dates[0]}"))

	# End time
	read -rp "End time: " end_time
	[[ $end_time ]] && end_time=$(date --date="$end_time" +%R)

	# Calendar
	for file in "$MCAL_DATA_DIR"/*; do
		[[ -f $file ]] && calendars+=("${file##*/}")
	done

	calendar=$(gum filter \
		--height=10 \
		--placeholder="" \
		--header.foreground="" \
		--indicator.foreground="12" \
		--match.foreground="12" \
		--header="Calendar: " \
		"${calendars[@]}")

	echo "Calendar: $calendar"

	# Tags
	read -rp "Tags: " tags_input
	read -ra tags <<< "$tags_input"

	if [[ -n ${tags[*]} ]]; then
		for tag in "${tags[@]}"; do
			tags_formatted+="${tag}:"
		done
	fi

	# Location
	read -rp "Location: " location
	[[ $location ]] && location=" <$location>"

	# Notes
	read -rp "Notes: " notes

	# Repeating event
	read -rp "Repeating event? (y/N): " repeat
	[[ $repeat == "y" ]] && repeating_event

	# Create calendar event
	for i in "${start_dates[@]}"; do
		create_event "$i"
	done
}

create_event()
{
	local start_date=$1
	local date
	local index

	date=$(printf "%(%F %a)T" "$start_date")

	if [[ $duration -gt $day ]]; then

		# First day of multi-day event
		index=1
		end_date=$((start_date + duration))

		printf "%s %s------ %s:%s [%s]%s%s %s\n" \
			"$date" \
			"${start_time:------}" \
			"$calendar" \
			"$tags_formatted" \
			"$title" \
			"$index" \
			"$location" \
			"$notes" \
			| tee -a "$MCAL_DATA_DIR/$calendar"

		# Middle days of multi-day event
		while [[ $start_date -lt $((end_date - day)) ]]; do

			((index++))
			start_date=$((start_date + day))
			date=$(printf "%(%F %a)T" "$start_date")

			printf "%s ----------- %s:%s [%s]%s%s\n" \
				"$date" \
				"$calendar" \
				"$tags_formatted" \
				"$title" \
				"$index" \
				"$location" \
				| tee -a "$MCAL_DATA_DIR/$calendar"

		done

		# Last day of multi-day event
		((index++))
		date=$(printf "%(%F %a)T" "$end_date")

		printf "%s ------%s %s:%s [%s]%s%s\n" \
			"$date" \
			"${end_time:------}" \
			"$calendar" \
			"$tags_formatted" \
			"$title" \
			"$index" \
			"$location" \
			| tee -a "$MCAL_DATA_DIR/$calendar"

	else

		# Single-day event
		printf "%s %s-%s %s:%s [%s]%s %s\n" \
			"$date" \
			"${start_time:------}" \
			"${end_time:------}" \
			"$calendar" \
			"$tags_formatted" \
			"$title" \
			"$location" \
			"$notes" \
			| tee -a "$MCAL_DATA_DIR/$calendar"

	fi
}

ordinal()
{
	local num=$1

	if [[ $((num % 100)) -ge 11 ]] && [[ $((num % 100)) -le 19 ]]; then
		echo "${num}th"
	elif [[ $((num % 10)) == 1 ]]; then
		echo "${num}st"
	elif [[ $((num % 10)) == 2 ]]; then
		echo "${num}nd"
	elif [[ $((num % 10)) == 3 ]]; then
		echo "${num}rd"
	else
		echo "${num}th"
	fi
}

birthdays()
{
	local current_year
	local name_in_events
	local bday_month_day
	local bday_output
	local bday_year
	local age
	local age_ordinal

	while IFS=$'\t' read -r bday_input name; do

		# Check if name from line in template already has
		# a birthday calendar event for the current year.
		# Create a new event only if one does not already exist.
		current_year=$(printf "%(%Y)T" -1)
		name_in_events=$(grep "${current_year}.*${name}" "$birthday_events")

		if [[ -z $name_in_events ]]; then

			bday_month_day=$(date --date="$bday_input" +"%m/%d")
			bday_output=$(date --date="$bday_month_day" +"%F %a")
			bday_year=$(date --date="$bday_input" +%Y)
			age=$((current_year - bday_year))

			[[ $age -gt 0 ]] && age_ordinal="$(ordinal $age) "

			printf "%s ----------- Birthdays: %s's %sbirthday\n" \
				"$bday_output" \
				"$name" \
				"${age_ordinal:-}" \
				>> "$birthday_events"

		fi

	done < "$template_birthdays"
}

week_view()
{
	local sm=$1     # Sunday or Monday
	local offset=$2 # Number of weeks forward or backward
	local week
	local first
	local last

	# Week number
	week=$(printf "%(%${sm})T" -1)

	# Set current day as first day of the week
	first=$(printf "%(%s)T" -1)

	# Walk backward to find week boundary
	while [[ $(printf "%(%${sm})T" "$first") == "$week" ]]; do
		first=$((first - day))
	done

	# Set first and last days of week
	first=$((first + day))
	last=$((first + (day * 6)))

	# Shift forward or backward by specified number of weeks
	if [[ -n $offset ]]; then
		offset=$((offset * day * 7))
		first=$((first + offset))
		last=$((last + offset))
	fi

	# Format first and last days of week for output
	first=$(printf "%(%F)T" "$first")
	last=$(printf "%(%F)T" "$last")

	echo "$events" | sort \
		| awk -v begin="$first" -v end="$last" '$1 >= begin && $1 <= end'
}

case $1 in
	"t")
		# Show all events for current day
		compile_events
		echo "$events" | sort | grep --color=auto "$(printf "%(%F)T" -1)"
		;;
	"m")
		# Show all events for current month
		compile_events
		echo "$events" | sort | grep --color=auto "$(printf "%(%Y-%m)T" -1)"
		;;
	"n")
		# Add new event interactively
		enter_new_event
		;;
	"b")
		# Add new birthday events from template
		birthdays
		;;
	"r")
		# Show all events from specified begin date to end date
		compile_events
		echo "$events" | sort \
			| awk -v begin="$2" -v end="$3" '$1 >= begin && $1 <= end'
		;;
	"wm")
		# Show all events for current week beginning Monday
		compile_events
		week_view "V" "$2"
		;;
	"ws")
		# Show all events for current week beginning Sunday
		compile_events
		week_view "U" "$2"
		;;
	"")
		# Show all events
		compile_events
		echo "$events" | sort
		;;
	*)
		# Show all events that match pattern
		compile_events
		echo "$events" | sort | grep --color=auto "${*}"
		;;
esac
