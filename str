#!/usr/bin/env bash

# Display workout log sheets for data stored in local text files.

data_dir="$HOME/sync/str"
data_file="$data_dir/main.tsv"

# Edit data files
[[ $1 == "e" ]] && (cd "$data_dir" && nvim -c FZF) && exit

function new_entry()
{
	exit
}

function print_report()
{
	width="61"

	# Header: description, location, date
	awk -v date="$selected_date" -v weekday="$weekday" -f str_header.awk "$data_file"

	# Exercise list
	awk -v date="$selected_date" -f str_main.awk "$data_file"

	# Footer: notes
	grep -P "${selected_date}\tnotes" "$data_file" \
		| cut --fields=3 \
		| fmt --width="$width" \
		| awk -f str_notes.awk
}

case $1 in
	"n")
		new_entry
		;;
	"t")
		# print report for today
		selected_date="$(date -I)"
		print_report
		;;
	*)
		# select from list of dates
		selected_date="$(awk -F "\t" '/^[[:digit:]]/ && $2 == "header" {printf "%s %s\n", $1, $3}' "$data_file" \
			| sort --unique --reverse \
			| gum filter --no-fuzzy \
			| cut --delimiter=" " --fields=1)"
		if [[ $selected_date ]]; then
			weekday="$(date --date=$selected_date +%A)"
			print_report
		fi
		;;
esac
